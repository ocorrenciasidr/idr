<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<title>SGCE - Nova Ocorrência</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#121212; color:#eaeaea; font-size:12px; }
  h2 { text-align:center; color:#fff; margin:18px 0; }
  .card { background:#151515; border:1px solid #2a2a2a; }
  label { color:#fff; }
  .form-control, .form-select, textarea { background:#0f0f0f; color:#fff; border:1px solid #2a2a2a; }
  .required { color:#f0ad4e; margin-left:6px; }
</style>
</head>
<body>
  <div class="container" style="max-width:900px; margin-top:20px;">
    <h2>Nova Ocorrência</h2>
    <div class="card p-4">
      <form id="frmNova" method="post" action="{{ url_for('criar_ocorrencia') }}">
        <!-- PROFESSOR / SALA -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label>Professor: <span class="required">*</span></label>
            <select id="selProfessor" name="PROFESSOR" class="form-select" required>
              <option value="">Selecione um Professor</option>
              {% for p in professores %}<option value="{{ p.nome }}">{{ p.nome }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label>Sala: <span class="required">*</span></label>
            <select id="selSala" name="SALA" class="form-select" required>
              <option value="">Selecione uma Sala</option>
              {% for s in salas %}<option value="{{ s.nome }}">{{ s.nome }}</option>{% endfor %}
            </select>
          </div>
        </div>

        <!-- ALUNO / TUTOR -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label>Aluno: <span class="required">*</span></label>
            <select id="selAluno" name="ALUNO" class="form-select" required>
              <option value="">Selecione um Aluno</option>
              <!-- Renderiza alunos com data-attrs para sala/tutor -->
              {% for a in alunos %}
                <option value="{{ a.nome }}" data-sala="{{ a.sala }}" data-tutor="{{ a.tutor }}">{{ a.nome }} {% if a.sala %} ({{ a.sala }}){% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label>Tutor:</label>
            <input id="inpTutor" name="TUTOR" class="form-control" readonly>
          </div>
        </div>

        <!-- DESCRIÇÃO -->
        <div class="mb-3">
          <label>Descrição da Ocorrência: <span class="required">*</span></label>
          <textarea name="DESCRICAO" class="form-control" rows="4" required></textarea>
        </div>

        <!-- Caixas de seleção FT/FC/FG -->
        <div class="mb-3">
          <label>Solicitar Ações:</label>
          <div class="form-check form-check-inline ms-2">
            <input class="form-check-input" type="checkbox" id="ft" name="FT" value="SIM">
            <label class="form-check-label" for="ft">Atendimento Tutor (FT)</label>
          </div>
          <div class="form-check form-check-inline ms-2">
            <input class="form-check-input" type="checkbox" id="fc" name="FC" value="SIM">
            <label class="form-check-label" for="fc">Atendimento Coordenação (FC)</label>
          </div>
          <div class="form-check form-check-inline ms-2">
            <input class="form-check-input" type="checkbox" id="fg" name="FG" value="SIM">
            <label class="form-check-label" for="fg">Atendimento Gestão (FG)</label>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <div>
            <button type="submit" id="btnRegistrar" class="btn btn-success">Registrar Ocorrência</button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancelar</a>
          </div>
        </div>
      </form>
    </div>
  </div>

<script>
  // ao selecionar sala, filtrar lista de alunos; ao selecionar aluno, preencher tutor
  const selSala = document.getElementById('selSala');
  const selAluno = document.getElementById('selAluno');
  const inpTutor = document.getElementById('inpTutor');

  function filtrarAlunosPorSala() {
    const sala = selSala.value;
    for (const opt of selAluno.options) {
      const optSala = opt.dataset.sala || '';
      // manter opção vazia sempre
      if (!opt.value) continue;
      opt.style.display = (!sala || optSala === sala) ? '' : 'none';
    }
    // reset selection
    selAluno.value = '';
    inpTutor.value = '';
  }
  selSala.addEventListener('change', filtrarAlunosPorSala);

  selAluno.addEventListener('change', () => {
    const opt = selAluno.selectedOptions[0];
    if (!opt) { inpTutor.value = ''; return; }
    inpTutor.value = opt.dataset.tutor || '';
  });

  // Validação: exigir todos os campos obrigatórios exceto checkboxes
  document.getElementById('frmNova').addEventListener('submit', function(e){
    const requiredFields = ['selProfessor','selSala','selAluno'];
    for (const id of requiredFields) {
      const el = document.getElementById(id);
      if (!el || !el.value) {
        e.preventDefault();
        el.focus();
        alert('Preencha todos os campos obrigatórios.');
        return false;
      }
    }
    // tudo ok -> submit form
  });
</script>
</body>
</html>
