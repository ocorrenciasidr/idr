<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>SGCE — Ocorrências</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f12;
      --panel:#0f1720;
      --card:#0b1114;
      --muted:#cbd5e1;
      --accent:#1f2937;
    }
    body{background:var(--bg); color:#e6eef8; font-family:Inter,system-ui, -apple-system, "Segoe UI", Roboto; padding:18px;}
    .container-main{max-width:1200px; margin:0 auto;}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
    h1{flex:1;text-align:center;margin:0;font-weight:700;color:#fff;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .filter-select{min-width:220px;}
    .btn-small{padding:.4rem .7rem;border-radius:8px;font-weight:600;}
    .panel{background:var(--panel); padding:16px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.6);}
    table{background:#f7efd6;border-collapse:collapse;width:100%;}
    thead th{background:#e9d8a6;color:#111;font-weight:700;padding:10px;border:1px solid rgba(0,0,0,.06);}
    tbody td{padding:10px;border:1px solid rgba(0,0,0,.04);color:#111;}
    tbody tr:nth-child(odd){background:#f6ecd0;}
    .status-atendimento{background:#f8d7da;color:#7a161b;padding:6px 8px;border-radius:6px;display:inline-block}
    .status-finalizada{background:#fff3cd;color:#856404;padding:6px 8px;border-radius:6px;display:inline-block}
    .status-assinada{background:#d4edda;color:#155724;padding:6px 8px;border-radius:6px;display:inline-block}
    .icon-button{cursor:pointer;padding:4px 8px;border-radius:6px;font-size:1.05rem}
    .ft-sim{color:#b02a37}
    .ft-nao{color:#2b8a3e}
    .table-wrap{max-height:62vh;overflow:auto;border-radius:8px;padding:6px;background:transparent;}
    .muted{color:var(--muted);font-size:.92rem}
    @media (max-width:900px){ .filter-select{min-width:160px} table{font-size:.9rem} }
  </style>
</head>
<body>
  <div class="container-main">
    <div class="panel">
      <div class="header">
        <h1>Sistema de Gestão de Convivência Escolar</h1>
      </div>

      <div class="controls mb-3">
        <form id="filtrosForm" method="get" action="{{ url_for('index') }}" style="display:flex;align-items:center;gap:8px;">
          <label class="muted">Tutor:</label>
          <select name="tutor_filtro" id="filterTutor" class="form-select filter-select">
            {% for t in tutores_disp %}
              <option value="{{ t }}" {% if filtro_tutor_sel==t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>

          <label class="muted">Status:</label>
          <select name="status_filtro" id="filterStatus" class="form-select filter-select">
            {% for s in status_disp %}
              <option value="{{ s }}" {% if filtro_status_sel==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>

          <button type="submit" class="btn btn-primary btn-small">Filtrar</button>
          <a href="{{ url_for('index') }}" class="btn btn-success btn-small">Limpar</a>
        </form>

        <div style="margin-left:auto; display:flex;gap:8px;">
          <a href="{{ url_for('nova') }}" class="btn btn-warning btn-small" style="background:#f59e0b;border:none;color:#111">Nova Ocorrência</a>
          <a href="{{ url_for('home') }}" class="btn btn-outline-light btn-small">Tela Inicial</a>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Data</th><th>Hora</th><th>Aluno</th><th>Sala</th><th>Professor</th><th>Tutor</th>
              <th>FT</th><th>FC</th><th>FG</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for r in registros %}
            <tr>
              <td>{{ r.ID }}</td>
              <td>{{ r.DCO or '' }}</td>
              <td>{{ r.HCO or '' }}</td>
              <td style="text-align:left">{{ r.ALUNO or '' }}</td>
              <td>{{ r.SALA or '' }}</td>
              <td>{{ r.PROFESSOR or '' }}</td>
              <td>{{ r.TUTOR or '' }}</td>

              <!-- FT -->
              <td>
                {% if r.FT == "SIM" %}
                  <a class="icon-button ft-sim" title="Abrir atendimento Tutor (FT)" href="{{ url_for('atendimento', oid=r.ID, tipo_acao='FT') }}">⚠️</a>
                {% else %}
                  <span class="icon-button ft-nao">✔️</span>
                {% endif %}
              </td>

              <!-- FC -->
              <td>
                {% if r.FC == "SIM" %}
                  <a class="icon-button ft-sim" title="Abrir atendimento Coordenação (FC)" href="{{ url_for('atendimento', oid=r.ID, tipo_acao='FC') }}">⚠️</a>
                {% else %}
                  <span class="icon-button ft-nao">✔️</span>
                {% endif %}
              </td>

              <!-- FG -->
              <td>
                {% if r.FG == "SIM" %}
                  <a class="icon-button ft-sim" title="Abrir atendimento Gestão (FG)" href="{{ url_for('atendimento', oid=r.ID, tipo_acao='FG') }}">⚠️</a>
                {% else %}
                  <span class="icon-button ft-nao">✔️</span>
                {% endif %}
              </td>

              <td>
                {% if r.STATUS == "ATENDIMENTO" %}
                  <span class="status-atendimento">ATENDIMENTO</span>
                {% elif r.STATUS == "FINALIZADA" %}
                  <span class="status-finalizada">FINALIZADA</span>
                {% elif r.STATUS == "ASSINADA" %}
                  <span class="status-assinada">ASSINADA</span>
                {% else %}
                  <span>{{ r.STATUS }}</span>
                {% endif %}
              </td>

              <td>
                <a href="{{ url_for('editar', oid=r.ID) }}" class="btn btn-info btn-small">Ver</a>
                <button class="btn btn-primary btn-small" onclick="editarCompletoPrompt({{ r.ID }})">Editar</button>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="12" style="text-align:center;color:#666;padding:20px;">Nenhuma ocorrência encontrada.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // Ao voltar ao foco atualize a página para refletir alterações salvas no servidor
  window.addEventListener('focus', function(){ 
    // recarrega apenas se a página veio de outra aba (evita reload constante)
    if (performance && performance.getEntriesByType('navigation')[0] && performance.getEntriesByType('navigation')[0].type !== 'reload') {
      location.reload();
    }
  });

  function editarCompletoPrompt(id){
    const senha = prompt("Senha para edição completa:");
    if(senha === null) return;
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/editar_completo/${id}`;
    const input = document.createElement('input');
    input.type = 'hidden'; input.name = 'senha'; input.value = senha;
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  }
</script>
</body>
</html>
