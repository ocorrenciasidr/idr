<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>SGCE - Editar Ocorrência</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { background-color: #121212; color: #f1f1f1; }
    h1 { text-align: center; margin-bottom: 30px; }
    .form-label { font-weight: 500; }
    .btn-success { background-color: #28a745; border: none; }
    .btn-success:hover { background-color: #218838; }
    .btn-warning { background-color: #ffc107; border: none; }
    .btn-warning:hover { background-color: #e0a800; }
    .card { background-color: #1e1e1e; border: none; }
    .form-control, .form-select { background-color: #2c2c2c; color: #f1f1f1; border: 1px solid #444; }
    .form-control:focus, .form-select:focus { background-color: #2c2c2c; color: #f1f1f1; border-color: #28a745; }
</style>
</head>
<body class="p-4">
<div class="container">
    <h1>Editar Ocorrência</h1>
    <div class="card shadow p-4">
        <form method="POST" action="{{ url_for('editar_ocorrencia', id=ocorrencia['ID']) }}">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Professor:</label>
                    <select class="form-select" name="PROFESSOR" required>
                        <option value="">Selecione um Professor</option>
                        {% for prof in professores_disp %}
                            <option value="{{ prof }}" {% if ocorrencia['PROFESSOR'] == prof %}selected{% endif %}>{{ prof }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Sala:</label>
                    <select class="form-select" name="SALA" id="sala-select" required onchange="carregarAlunos()">
                        <option value="">Selecione uma Sala</option>
                        {% for sala in salas_disp %}
                            <option value="{{ sala }}" {% if ocorrencia['SALA'] == sala %}selected{% endif %}>{{ sala }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Aluno:</label>
                    <select class="form-select" name="ALUNO" id="aluno-select" required onchange="selecionarTutor()">
                        <option value="{{ ocorrencia['ALUNO'] }}">{{ ocorrencia['ALUNO'] }}</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Tutor:</label>
                    <input type="text" class="form-control" name="TUTOR" id="tutor-input" value="{{ ocorrencia['TUTOR'] }}" readonly required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Descrição da Ocorrência:</label>
                <textarea class="form-control" name="DESCRICAO" rows="3" required>{{ ocorrencia['DESCRICAO'] }}</textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">ATP (Atendimento Professor):</label>
                <textarea class="form-control" name="ATP" rows="2">{{ ocorrencia['ATP'] }}</textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Solicitar Ações:</label>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FT" id="checkFT" {% if ocorrencia['FT'] %}checked{% endif %}>
                            <label class="form-check-label" for="checkFT">Atendimento Tutor (FT)</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FC" id="checkFC" {% if ocorrencia['FC'] %}checked{% endif %}>
                            <label class="form-check-label" for="checkFC">Atendimento Coordenação (FC)</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FG" id="checkFG" {% if ocorrencia['FG'] %}checked{% endif %}>
                            <label class="form-check-label" for="checkFG">Atendimento Gestão (FG)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="submit" class="btn btn-success">Salvar Alterações</button>
                <a href="{{ url_for('index') }}" class="btn btn-warning">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
let alunosCache = {};

async function carregarAlunos() {
    const salaSelect = document.getElementById('sala-select');
    const alunoSelect = document.getElementById('aluno-select');
    const tutorInput = document.getElementById('tutor-input');
    const sala = salaSelect.value;

    alunoSelect.innerHTML = '<option value="">Selecione um Aluno</option>';
    tutorInput.value = '';

    if (!sala) return;

    let alunosPorSala = alunosCache[sala];
    if (!alunosPorSala) {
        try {
            const response = await fetch(`/api/alunos_por_sala/${encodeURIComponent(sala)}`);
            if (!response.ok) throw new Error('Erro ao buscar alunos');
            alunosPorSala = await response.json();
            alunosCache[sala] = alunosPorSala;
        } catch (error) {
            console.error(error);
            alunoSelect.innerHTML = '<option value="">Erro ao carregar alunos</option>';
            return;
        }
    }

    alunosPorSala.forEach(aluno => {
        const option = document.createElement('option');
        option.value = aluno.Aluno;
        option.textContent = aluno.Aluno;
        option.dataset.tutor = aluno.Tutor;
        if(aluno.Aluno === "{{ ocorrencia['ALUNO'] }}") option.selected = true;
        alunoSelect.appendChild(option);
    });
    selecionarTutor();
}

function selecionarTutor() {
    const alunoSelect = document.getElementById('aluno-select');
    const tutorInput = document.getElementById('tutor-input');
    const selectedOption = alunoSelect.options[alunoSelect.selectedIndex];
    tutorInput.value = selectedOption?.dataset.tutor || '';
}

// Carrega alunos automaticamente na página com a sala selecionada
document.addEventListener("DOMContentLoaded", carregarAlunos);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
