<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>SGCE - Relatório Geral</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  body { background-color:#121212; color:#eaeaea; font-size:13px; }
  h2 { text-align:center; margin:25px 0; color:#fff; }
  .card { background:#1e1e1e; border:1px solid #333; }
  table { color:#fff; font-size:12px; }
  thead { background-color:#1b1b1b; }
  .btn-voltar { position:absolute; left:20px; top:20px; }
</style>
</head>
<body>

<a href="{{ url_for('relatorio_inicial') }}" class="btn btn-secondary btn-voltar">← Voltar</a>
<div class="container mt-4" style="max-width:900px;">
  <h2>Relatório Geral de Ocorrências</h2>

  <form method="get" action="{{ url_for('relatorio_geral') }}" class="card p-3 mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-5">
        <label for="data_inicio" class="form-label">Data Inicial:</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ data_inicio or '' }}">
      </div>
      <div class="col-md-5">
        <label for="data_fim" class="form-label">Data Final:</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ data_fim or '' }}">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-success w-100">Gerar</button>
      </div>
    </div>
  </form>

  {% if relatorio_sala %}
  <div class="card p-3">
    <h5 class="text-center mb-3">Ocorrências por Sala</h5>
    <table class="table table-striped table-bordered text-center">
      <thead><tr><th>Sala</th><th>Ocorrências</th><th>Respondidas</th><th>Não Respondidas</th></tr></thead>
      <tbody>
        {% for r in relatorio_sala %}
        <tr>
          <td>{{ r['SALA'] }}</td>
          <td>{{ r['TOTAL'] }}</td>
          <td>{{ r['RESPONDIDAS'] }}</td>
          <td>{{ r['NAO_RESPONDIDAS'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h5 class="text-center mt-4 mb-3">Resumo por Setor</h5>
    <table class="table table-bordered table-striped text-center">
      <thead><tr><th>Setor</th><th>Menos de 7 dias</th><th>Mais de 7 dias</th><th>Não Respondidas</th></tr></thead>
      <tbody>
        {% for s in relatorio_setor %}
        <tr>
          <td>{{ s['SETOR'] }}</td>
          <td>{{ s['MENOS7'] }}</td>
          <td>{{ s['MAIS7'] }}</td>
          <td>{{ s['NAO'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-center mt-3">
      <button id="btnPDF" class="btn btn-primary">Baixar PDF</button>
    </div>
  </div>
  {% elif data_inicio and data_fim %}
    <p class="text-center text-warning">Nenhuma ocorrência encontrada no período informado.</p>
  {% endif %}
</div>

<script>
document.getElementById("btnPDF")?.addEventListener("click", ()=>{
  const doc = new jspdf.jsPDF();
  doc.setFontSize(12);
  doc.text("Relatório Geral de Ocorrências", 20, 20);
  doc.text("Período: {{ data_inicio or '' }} a {{ data_fim or '' }}", 20, 30);
  doc.line(20, 33, 190, 33);

  let y = 45;
  doc.text("Ocorrências por Sala:", 20, y); y += 6;
  {% for r in relatorio_sala %}
    doc.text("Sala {{ r['SALA'] }} - Total: {{ r['TOTAL'] }}, Resp: {{ r['RESPONDIDAS'] }}, Não Resp: {{ r['NAO_RESPONDIDAS'] }}", 20, y);
    y += 6; if (y > 270) { doc.addPage(); y = 20; }
  {% endfor %}

  y += 10;
  doc.text("Resumo por Setor:", 20, y); y += 6;
  {% for s in relatorio_setor %}
    doc.text("{{ s['SETOR'] }} - <7d: {{ s['MENOS7'] }}, >7d: {{ s['MAIS7'] }}, Não Resp: {{ s['NAO'] }}", 20, y);
    y += 6; if (y > 270) { doc.addPage(); y = 20; }
  {% endfor %}
  
  doc.save("Relatorio_Geral.pdf");
});
</script>

</body>
</html>
