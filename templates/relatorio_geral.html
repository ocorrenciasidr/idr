<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SGCE - ESTAT√çTICA GERAL DE OCORR√äNCIAS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container mt-5">
    <h1 class="mb-4 text-center">SISTEMA DE GEST√ÉO DE OCORR√äNCIA ESCOLAR <br> ESTAT√çSTICA GERAL DE OCORR√äNCIAS </h1>

    <!-- Formul√°rio para Filtrar (GET) -->
    <form method="get" action="{{ url_for('relatorio_geral') }}" id="filtroForm" class="row g-3 mb-4 align-items-end">
        <div class="col-md-3">
            <label for="data_inicio" class="form-label">Data In√≠cio:</label>
            <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio }}">
        </div>
        <div class="col-md-3">
            <label for="data_fim" class="form-label">Data Fim:</label>
            <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
        </div>
        <div class="col-md-6 d-flex">
            <button type="submit" class="btn btn-primary me-2">Filtrar</button>
            <!-- Bot√£o que aciona a submiss√£o do formul√°rio de PDF via JS -->
            <button type="button" class="btn btn-success me-2" onclick="gerarPdf()">üìÑ Gerar PDF</button>
            <a href="{{ url_for('relatorio_inicial') }}" class="btn btn-secondary">Voltar</a>
        </div>
    </form>
    
    <!-- Formul√°rio oculto para gerar PDF (POST) -->
    <form method="post" action="{{ url_for('gerar_pdf_geral') }}" id="pdfForm" style="display:none;">
        <input type="hidden" name="data_inicio_pdf" id="data_inicio_pdf">
        <input type="hidden" name="data_fim_pdf" id="data_fim_pdf">
    </form>
    
    <!-- Script para passar os filtros do GET para o POST do PDF -->
    <script>
        function gerarPdf() {
            // Pega os valores atuais dos campos de data no formul√°rio de filtro
            const dataInicio = document.getElementById('data_inicio').value;
            const dataFim = document.getElementById('data_fim').value;

            // Define os valores nos campos ocultos do formul√°rio de PDF
            document.getElementById('data_inicio_pdf').value = dataInicio;
            document.getElementById('data_fim_pdf').value = dataFim;

            // Submete o formul√°rio de PDF
            document.getElementById('pdfForm').submit();
        }
    </script>

    {% if ocorrencias %}
        <div class="mt-4">
            {% if grafico_base64 %}
                <!-- Exibi√ß√£o do gr√°fico -->
                <div class="text-center mb-4">
                    <img src="data:image/png;base64,{{ grafico_base64 }}" class="img-fluid" alt="Gr√°fico de Status de Ocorr√™ncias">
                </div>
            {% else %}
                <div class="alert alert-warning text-center">
                    N√£o h√° dados suficientes para gerar o gr√°fico ou o Matplotlib n√£o est√° instalado.
                </div>
            {% endif %}

            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Aluno</th>
                            <th>Sala</th>
                            <th>Status</th>
                            <th>Prazo 7 dias</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for o in ocorrencias %}
                            <tr>
                                <td>{{ o["ID"] }}</td>
                                <td>{{ o["Aluno"] }}</td>
                                <td>{{ o["Sala"] }}</td>
                                <td>{{ o["Status"] }}</td>
                                <td>{{ o["Prazo"] }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info text-center mt-4">
            Nenhuma ocorr√™ncia encontrada para o per√≠odo selecionado.
        </div>
    {% endif %}
</div>
<!-- Rodap√© -->
    <footer class="text-center mt-5 mb-3">
        <small>Desenvolvido: Marcelo Andr√© Nogueira Cardes <br> Licenciado: EE PEI Prof¬™ Irene Dias Ribeiro</small>
    </footer>
</body>
</html>
