<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>SGCE - Relatório Geral</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  body { background:#121212; color:#eaeaea; font-size:12px; }
  h2 { text-align:center; color:#fff; margin:20px 0; }
  .card { background:#1b1b1b; border:1px solid #333; }
  .table { color:#fff; }
  thead { background:#1e1e1e; }
</style>
</head>
<body>
<div class="container mt-3" style="max-width:950px;">
  <h2>Relatório Geral de Ocorrências</h2>

  <div class="card p-3 mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-5">
        <label>Data Inicial</label>
        <input type="date" id="dataIni" class="form-control">
      </div>
      <div class="col-md-5">
        <label>Data Final</label>
        <input type="date" id="dataFim" class="form-control">
      </div>
      <div class="col-md-2">
        <button id="btnGerar" class="btn btn-success w-100">Gerar</button>
      </div>
    </div>
  </div>

  <div id="resultado" style="display:none;">
    <h5 class="text-center mb-3">Resumo das Ocorrências</h5>
    <div id="tabelasResumo"></div>
    <div class="text-center mt-3">
      <button id="btnPDF" class="btn btn-primary">Baixar PDF</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabaseUrl = "https://SEU_SUPABASE_URL";
const supabaseKey = "SEU_SUPABASE_ANON_KEY";
const supabase = createClient(supabaseUrl, supabaseKey);

const btnGerar = document.getElementById("btnGerar");
const dataIni = document.getElementById("dataIni");
const dataFim = document.getElementById("dataFim");
const resultado = document.getElementById("resultado");
const tabelasResumo = document.getElementById("tabelasResumo");
const btnPDF = document.getElementById("btnPDF");

let ocorrencias = [];

btnGerar.addEventListener("click", async ()=>{
  if (!dataIni.value || !dataFim.value) return alert("Informe o período completo!");
  const { data, error } = await supabase.from("ocorrencias")
    .select("*")
    .gte("DCO", dataIni.value)
    .lte("DCO", dataFim.value);
  if (error) return console.error(error);
  ocorrencias = data;
  if (!data.length) return alert("Nenhuma ocorrência encontrada.");

  gerarResumo();
  resultado.style.display = "block";
});

function gerarResumo(){
  const porSala = {};
  ocorrencias.forEach(o=>{
    if (!porSala[o.SALA]) porSala[o.SALA]=[];
    porSala[o.SALA].push(o);
  });

  let html = `<table class='table table-bordered table-striped text-center'>
  <thead><tr><th>Sala</th><th>Qtde Ocorrências</th></tr></thead><tbody>`;
  Object.keys(porSala).forEach(s=>{
    html += `<tr><td>${s}</td><td>${porSala[s].length}</td></tr>`;
  });
  html += "</tbody></table>";

  const total = ocorrencias.length;
  const finalizadas = ocorrencias.filter(o=>o.STATUS=="FINALIZADA").length;
  const atendimento = ocorrencias.filter(o=>o.STATUS=="ATENDIMENTO").length;
  const assinadas = ocorrencias.filter(o=>o.STATUS=="ASSINADA").length;

  html += `<div class="mt-3">
  <h6>Resumo Geral</h6>
  <p>Total: ${total} | Atendimentos: ${atendimento} | Finalizadas: ${finalizadas} | Assinadas: ${assinadas}</p>
  </div>`;

  tabelasResumo.innerHTML = html;
}

btnPDF.addEventListener("click", ()=>{
  const doc = new jspdf.jsPDF();
  doc.setFontSize(12);
  doc.text("RELATÓRIO GERAL DE OCORRÊNCIAS", 20, 20);
  doc.text(`Período: ${dataIni.value} a ${dataFim.value}`, 20, 30);
  let y = 45;
  ocorrencias.forEach(o=>{
    doc.text(`${o.SALA} - ${o.ALUNO} - ${o.PROFESSOR} - ${o.STATUS}`, 20, y, {maxWidth:170});
    y += 6;
    if (y>270){doc.addPage(); y=20;}
  });
  doc.save("Relatorio_Geral.pdf");
});
</script>
</body>
</html>
