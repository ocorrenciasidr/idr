<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>SGCE - Relatório Geral</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  body { background:#121212; color:#eaeaea; font-size:12px; }
  h2 { text-align:center; color:#fff; margin:20px 0; }
  .card { background:#1b1b1b; border:1px solid #333; }
  .table { color:#fff; }
  thead { background:#1e1e1e; }
  canvas { background:#1a1a1a; border-radius:8px; padding:10px; }
  .resumo-box { background:#1e1e1e; padding:10px; border-radius:6px; }
</style>
</head>
<body>
<div class="container mt-3" style="max-width:950px;">
  <h2>Relatório Geral de Ocorrências</h2>

  <div class="card p-3 mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-5">
        <label>Data Inicial</label>
        <input type="date" id="dataIni" class="form-control">
      </div>
      <div class="col-md-5">
        <label>Data Final</label>
        <input type="date" id="dataFim" class="form-control">
      </div>
      <div class="col-md-2">
        <button id="btnGerar" class="btn btn-success w-100">Gerar</button>
      </div>
    </div>
  </div>

  <div id="resultado" style="display:none;">
    <h5 class="text-center mb-3">Resumo das Ocorrências</h5>

    <div id="resumoGeral" class="resumo-box mb-3 text-center"></div>

    <div class="row">
      <div class="col-md-6">
        <canvas id="graficoSalas"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="graficoStatus"></canvas>
      </div>
    </div>

    <h6 class="mt-4">Ocorrências por Sala</h6>
    <table class='table table-bordered table-striped text-center'>
      <thead><tr><th>Sala</th><th>Qtde Ocorrências</th></tr></thead>
      <tbody id="tabelaSalas"></tbody>
    </table>

    <div class="text-center mt-3">
      <button id="btnPDF" class="btn btn-primary">Baixar PDF</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabaseUrl = "https://SEU_SUPABASE_URL";
const supabaseKey = "SEU_SUPABASE_ANON_KEY";
const supabase = createClient(supabaseUrl, supabaseKey);

const btnGerar = document.getElementById("btnGerar");
const dataIni = document.getElementById("dataIni");
const dataFim = document.getElementById("dataFim");
const resultado = document.getElementById("resultado");
const tabelaSalas = document.getElementById("tabelaSalas");
const resumoGeral = document.getElementById("resumoGeral");
const btnPDF = document.getElementById("btnPDF");
let graficoSalas, graficoStatus;
let ocorrencias = [];

btnGerar.addEventListener("click", async ()=>{
  if (!dataIni.value || !dataFim.value) return alert("Informe o período completo!");
  const { data, error } = await supabase.from("ocorrencias")
    .select("*")
    .gte("DCO", dataIni.value)
    .lte("DCO", dataFim.value);
  if (error) return console.error(error);
  ocorrencias = data;
  if (!data.length) return alert("Nenhuma ocorrência encontrada no período.");

  gerarResumo();
  resultado.style.display = "block";
});

function gerarResumo(){
  // Agrupar por sala
  const porSala = {};
  ocorrencias.forEach(o=>{
    if (!porSala[o.SALA]) porSala[o.SALA]=[];
    porSala[o.SALA].push(o);
  });

  tabelaSalas.innerHTML = "";
  Object.entries(porSala).forEach(([sala, lista])=>{
    tabelaSalas.innerHTML += `<tr><td>${sala}</td><td>${lista.length}</td></tr>`;
  });

  const total = ocorrencias.length;
  const finalizadas = ocorrencias.filter(o=>o.STATUS=="FINALIZADA").length;
  const atendimento = ocorrencias.filter(o=>o.STATUS=="ATENDIMENTO").length;
  const assinadas = ocorrencias.filter(o=>o.STATUS=="ASSINADA").length;

  resumoGeral.innerHTML = `
    <h6 class="mb-2">Resumo Geral</h6>
    <p>Total: <b>${total}</b> | Atendimentos: ${atendimento} (${((atendimento/total)*100).toFixed(1)}%) |
    Finalizadas: ${finalizadas} (${((finalizadas/total)*100).toFixed(1)}%) |
    Assinadas: ${assinadas} (${((assinadas/total)*100).toFixed(1)}%)</p>`;

  gerarGraficos(porSala, { atendimento, finalizadas, assinadas });
}

function gerarGraficos(porSala, statusData){
  const ctxSala = document.getElementById("graficoSalas");
  const ctxStatus = document.getElementById("graficoStatus");

  if (graficoSalas) graficoSalas.destroy();
  if (graficoStatus) graficoStatus.destroy();

  graficoSalas = new Chart(ctxSala, {
    type: 'bar',
    data: {
      labels: Object.keys(porSala),
      datasets: [{
        label: 'Ocorrências por Sala',
        data: Object.values(porSala).map(v=>v.length),
        backgroundColor: '#4caf50'
      }]
    },
    options: {
      plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#eaeaea'}}, y:{ticks:{color:'#eaeaea'}}}
    }
  });

  graficoStatus = new Chart(ctxStatus, {
    type: 'pie',
    data: {
      labels: ['Atendimento','Finalizada','Assinada'],
      datasets: [{
        data: [statusData.atendimento, statusData.finalizadas, statusData.assinadas],
        backgroundColor: ['#ffc107','#28a745','#17a2b8']
      }]
    },
    options: { plugins:{legend:{labels:{color:'#fff'}}} }
  });
}

btnPDF.addEventListener("click", ()=>{
  const doc = new jspdf.jsPDF();
  doc.setFontSize(12);
  doc.text("RELATÓRIO GERAL DE OCORRÊNCIAS", 20, 20);
  doc.text(`Período: ${dataIni.value} a ${dataFim.value}`, 20, 30);

  let y = 45;
  for (const tr of tabelaSalas.querySelectorAll("tr")) {
    const tds = tr.querySelectorAll("td");
    if (tds.length) {
      doc.text(`${tds[0].textContent}: ${tds[1].textContent} ocorrências`, 20, y);
      y += 6;
      if (y>270){doc.addPage(); y=20;}
    }
  }

  y += 10;
  doc.text("Resumo:", 20, y);
  y += 6;
  doc.text(resumoGeral.innerText, 20, y, {maxWidth:170});
  doc.save("Relatorio_Geral.pdf");
});
</script>
</body>
</html>
