<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Conviv√™ncia - IDR</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { background: #f4f4f4; }
        .container { margin-top: 40px; }
        table th, table td { vertical-align: middle; text-align: center; }
        h2 { text-align: center; margin-bottom: 30px; }
        .btn-sm { padding: 2px 6px; font-size: 0.8rem; }
    </style>
</head>
<body>
<div class="container">
    <h2>Sistema de Gest√£o de Conviv√™ncia - IDR</h2>

    <!-- Formul√°rio de Filtros -->
    <form method="get" class="row mb-4">
        <div class="col-md-3">
            <label for="tutor" class="form-label">Tutor</label>
            <select name="tutor" id="tutor" class="form-select">
                <option value="">Todos</option>
                {% for t in tutores %}
                    <option value="{{ t }}" {% if request.args.get('tutor') == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="status" class="form-label">Status</label>
            <select name="status" id="status" class="form-select">
                <option value="">Todos</option>
                <option value="Em Atendimento" {% if request.args.get('status') == 'Em Atendimento' %}selected{% endif %}>Em Atendimento</option>
                <option value="Finalizada" {% if request.args.get('status') == 'Finalizada' %}selected{% endif %}>Finalizada</option>
                <option value="Assinada" {% if request.args.get('status') == 'Assinada' %}selected{% endif %}>Assinada</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="sala" class="form-label">Sala</label>
            <select name="sala" id="sala" class="form-select">
                <option value="">Todas</option>
                {% for s in salas %}
                    <option value="{{ s }}" {% if request.args.get('sala') == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="aluno" class="form-label">Aluno</label>
            <select name="aluno" id="aluno" class="form-select">
                <option value="">Todos</option>
                {% for a in alunos %}
                    <option value="{{ a }}" {% if request.args.get('aluno') == a %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-12 mt-3 d-flex justify-content-between">
            <button type="submit" class="btn btn-primary">Filtrar</button>
            <a href="{{ url_for('nova') }}" class="btn btn-success">Nova Ocorr√™ncia</a>
        </div>
    </form>

    <!-- Tabela -->
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
        <tr>
            <th>N¬∫</th>
            <th>Data</th>
            <th>Hora</th>
            <th>Professor</th>
            <th>Sala</th>
            <th>Aluno</th>
            <th>Tutor</th>
            <th>Status</th>
            <th>Pend. Tutor</th>
            <th>Pend. Coord</th>
            <th>Pend. Gest√£o</th>
            <th>A√ß√µes</th>
        </tr>
        </thead>
        <tbody>
        {% for reg in registros %}
            <tr>
                <td>{{ reg["N¬∫ Ocorr√™ncia"] }}</td>
                <td>{{ reg["Data Cria√ß√£o"] }}</td>
                <td>{{ reg["Hora Cria√ß√£o"] }}</td>
                <td>{{ reg["Professor"] }}</td>
                <td>{{ reg["Sala"] }}</td>
                <td>{{ reg["Aluno"] }}</td>
                <td>{{ reg["Tutor"] }}</td>
                <td>{{ reg["Status"] }}</td>

                <td>
                    {% if reg.get("FlagTutor") == "Sim" %}
                        <a href="{{ url_for('editar', oid=reg['N¬∫ Ocorr√™ncia'], campo='tutor') }}" class="btn btn-outline-primary btn-sm">Sim</a>
                    {% else %}N√£o{% endif %}
                </td>
                <td>
                    {% if reg.get("FlagCoord") == "Sim" %}
                        <a href="{{ url_for('editar', oid=reg['N¬∫ Ocorr√™ncia'], campo='coord') }}" class="btn btn-outline-warning btn-sm">Sim</a>
                    {% else %}N√£o{% endif %}
                </td>
                <td>
                    {% if reg.get("FlagGestao") == "Sim" %}
                        <button class="btn btn-outline-danger btn-sm"
                                onclick="const pwd = prompt('Senha para Gest√£o:'); if (pwd==='Gest@0IDR'){window.location.href='{{ url_for('editar', oid=reg['N¬∫ Ocorr√™ncia'], campo='gestao') }}';} else if (pwd!==null){alert('Senha incorreta!');}">
                            Sim
                        </button>
                    {% else %}N√£o{% endif %}
                </td>

                <td class="text-center">
                    <a href="{{ url_for('editar', oid=reg['N¬∫ Ocorr√™ncia'], campo='view') }}" class="btn btn-secondary btn-sm" title="Visualizar">
                        üîç
                    </a>
                    <button class="btn btn-primary btn-sm"
                            onclick="const p=prompt('Senha para edi√ß√£o:'); if(p==='Gest@0IDR'){window.location.href='{{ url_for('editar', oid=reg['N¬∫ Ocorr√™ncia'], campo='edit') }}';}"
                            title="Editar">
                        ‚úèÔ∏è
                    </button>
                    <a href="{{ url_for('marcar_assinada', oid=reg['N¬∫ Ocorr√™ncia']) }}" class="btn btn-success btn-sm" title="Marcar como Assinada">
                        üñ®Ô∏è
                    </a>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="12" class="text-center">Nenhuma ocorr√™ncia encontrada.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="text-center mt-4">
        <button
            class="btn btn-info"
            onclick="const s=prompt('Digite a senha para acessar relat√≥rios:'); if(s==='Gest@0IDR'){window.location.href='{{ url_for('relatorio') }}';} else if(s!==null){alert('Senha incorreta!');}">
            Relat√≥rios
        </button>
    </div>
</div>

<script>
document.getElementById('sala').addEventListener('change', function(){
    const sala = this.value;
    const alunoSel = document.getElementById('aluno');
    alunoSel.innerHTML = '<option>Carregando...</option>';
    if (sala) {
        fetch(`/api/alunos/${encodeURIComponent(sala)}`)
            .then(r => r.json())
            .then(lista => {
                alunoSel.innerHTML = '<option value="">Todos</option>';
                lista.forEach(a => {
                    const op = document.createElement('option');
                    op.value = a;
                    op.textContent = a;
                    alunoSel.appendChild(op);
                });
            })
            .catch(() => alunoSel.innerHTML = '<option value="">Erro ao carregar alunos</option>');
    } else {
        alunoSel.innerHTML = '<option value="">Todos</option>';
    }
});
</script>
</body>
</html>
