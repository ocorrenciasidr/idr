<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>SGCE - Relatório por Aluno</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  body { background-color: #121212; color: #eaeaea; font-size: 12px; }
  h2 { text-align: center; color: #fff; margin: 20px 0; }
  .container { max-width: 900px; }
  select, button { font-size: 12px; }
  .card { background: #1b1b1b; border: 1px solid #333; }
  table { color: #fff; }
  thead { background: #1e1e1e; }
  .btn { font-size: 12px; }
</style>
</head>
<body>
<div class="container mt-3">
  <h2>Relatório Individual do Aluno</h2>

  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Sala</label>
        <select id="selSala" class="form-select">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label">Aluno</label>
        <select id="selAluno" class="form-select" disabled>
          <option value="">Selecione uma sala primeiro...</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-success w-100" id="btnGerar" disabled>Gerar PDF</button>
      </div>
    </div>
  </div>

  <div id="listaOcorrencias" class="card p-3" style="display:none;">
    <h6 class="mb-2">Ocorrências registradas:</h6>
    <table class="table table-dark table-striped table-sm align-middle text-center">
      <thead>
        <tr><th>#</th><th>Data</th><th>Professor</th><th>Descrição</th><th>Status</th><th>Selecionar</th></tr>
      </thead>
      <tbody id="tabelaOcorrencias"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabaseUrl = "https://SEU_SUPABASE_URL";
const supabaseKey = "SEU_SUPABASE_ANON_KEY";
const supabase = createClient(supabaseUrl, supabaseKey);

const selSala = document.getElementById("selSala");
const selAluno = document.getElementById("selAluno");
const btnGerar = document.getElementById("btnGerar");
const tabelaOcorrencias = document.getElementById("tabelaOcorrencias");
const listaOcorrencias = document.getElementById("listaOcorrencias");

let alunos = [];
let ocorrencias = [];

// Carregar Salas
async function carregarSalas() {
  const { data, error } = await supabase.from("Salas").select("*");
  if (error) return console.error(error);
  data.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.Sala;
    opt.textContent = s.Sala;
    selSala.appendChild(opt);
  });
}
carregarSalas();

// Carregar Alunos ao escolher Sala
selSala.addEventListener("change", async () => {
  selAluno.innerHTML = '<option value="">Selecione...</option>';
  selAluno.disabled = true;
  listaOcorrencias.style.display = "none";
  btnGerar.disabled = true;
  const sala = selSala.value;
  if (!sala) return;
  const { data, error } = await supabase.from("Alunos").select("*").eq("Sala", sala);
  if (error) return console.error(error);
  alunos = data;
  data.forEach(a => {
    const opt = document.createElement("option");
    opt.value = a.Aluno;
    opt.textContent = a.Aluno;
    selAluno.appendChild(opt);
  });
  selAluno.disabled = false;
});

// Carregar Ocorrências ao escolher Aluno
selAluno.addEventListener("change", async () => {
  tabelaOcorrencias.innerHTML = "";
  listaOcorrencias.style.display = "none";
  btnGerar.disabled = true;
  const aluno = selAluno.value;
  if (!aluno) return;
  const { data, error } = await supabase.from("ocorrencias").select("*").eq("ALUNO", aluno);
  if (error) return console.error(error);
  ocorrencias = data;
  if (!data.length) {
    tabelaOcorrencias.innerHTML = "<tr><td colspan='6'>Nenhuma ocorrência encontrada.</td></tr>";
  } else {
    data.forEach((o, i) => {
      tabelaOcorrencias.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${o.DCO?.substring(0,10)}</td>
          <td>${o.PROFESSOR || ""}</td>
          <td class="text-start">${o.DESCRICAO || ""}</td>
          <td>${o.STATUS || ""}</td>
          <td><input type="checkbox" class="chkSel" data-id="${o.ID}"></td>
        </tr>`;
    });
    listaOcorrencias.style.display = "block";
    btnGerar.disabled = false;
  }
});

// Gerar PDF
btnGerar.addEventListener("click", async () => {
  const selecionados = [...document.querySelectorAll(".chkSel:checked")].map(ch => ch.dataset.id);
  if (!selecionados.length) return alert("Selecione ao menos uma ocorrência.");
  const aluno = selAluno.value;
  const sala = selSala.value;
  const doc = new jspdf.jsPDF();
  doc.setFontSize(12);
  doc.text("RELATÓRIO DE REGISTRO DE OCORRÊNCIAS", 20, 20);
  doc.text("E.E. PEI PROFESSOR IRENE DIAS RIBEIRO", 20, 30);
  doc.text(`Aluno: ${aluno}`, 20, 40);
  doc.text(`Sala: ${sala}`, 150, 40);
  doc.line(20, 45, 190, 45);

  let y = 55;
  for (const id of selecionados) {
    const o = ocorrencias.find(x => x.ID == id);
    doc.text(`Ocorrência nº: ${o.ID}`, 20, y);
    doc.text(`Data: ${o.DCO?.substring(0,10) || ""}`, 120, y);
    y += 6;
    doc.text(`Professor: ${o.PROFESSOR || ""}`, 20, y);
    y += 6;
    doc.text("Descrição:", 20, y);
    y += 5;
    doc.text(o.DESCRICAO || "", 25, y, { maxWidth: 160 });
    y += 20;
    doc.text("Atendimento Tutor / Coordenação / Gestão:", 20, y);
    y += 6;
    doc.text(`${o.ATT || "NÃO APLICÁVEL"} / ${o.ATC || "NÃO APLICÁVEL"} / ${o.ATG || "NÃO APLICÁVEL"}`, 25, y, { maxWidth: 160 });
    y += 12;
    doc.line(20, y, 190, y);
    y += 8;
    if (y > 260) { doc.addPage(); y = 20; }
  }

  doc.text("Assinatura Responsável: ____________________________", 20, y+10);
  doc.text("Data: ____ / ____ / ______", 140, y+10);
  doc.save(`Relatorio_${aluno}.pdf`);

  // Atualizar status no Supabase
  for (const id of selecionados) {
    await supabase.from("ocorrencias").update({ STATUS: "ASSINADA" }).eq("ID", id);
  }
  alert("Relatório gerado e status atualizado com sucesso!");
});
</script>
</body>
</html>
